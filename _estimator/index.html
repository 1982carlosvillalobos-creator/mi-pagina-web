<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Golden Charge - Estimador Profesional v11.0 FINAL</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf-autotable.min.js"></script>
  <style>
    :root {
      --gold: #FFD700; --dark-blue: #0A2463; --light-gray: #f8f9fa;
      --text: #1e1e1e; --card-bg: #ffffff; --border: #ddd;
      --btn-bg: var(--dark-blue); --btn-text: var(--gold);
      --shadow: 0 5px 20px rgba(0,0,0,.1); --radius: 12px;
    }
    body { font-family: 'Inter', sans-serif; background: var(--light-gray); }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    .header { text-align: center; margin-bottom: 30px; }
    h1, h2, h3 { color: var(--dark-blue); }
    .app { display: none; background: var(--card-bg); padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow); }
    .section { background: #fff; padding: 20px; border-radius: var(--radius); margin-bottom: 20px; border: 1px solid var(--border); }
    .section-title { font-size: 1.2rem; margin-bottom: 15px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.95rem; }
    .form-control, .btn { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem; }
    .controls { display: flex; align-items: center; gap: 10px; margin: 8px 0; }
    .controls button { background: var(--dark-blue); color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; }
    .controls span { font-size: 1.1rem; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 10px; text-align: left; border: 1px solid var(--border); }
    th { background: var(--dark-blue); color: var(--gold); }
    .btn { background: var(--btn-bg); color: var(--btn-text); border-radius: 50px; cursor: pointer; font-weight: bold; margin-top: 10px; }
    .btn:disabled { background-color: #ccc; cursor: not-allowed; }
    .btn-pdf { background: #007BFF; color: white; }
    .search-container { position: relative; }
    .search-results { position: absolute; top: 100%; left: 0; right: 0; max-height: 300px; overflow-y: auto; background: white; border: 1px solid var(--border); border-radius: 8px; z-index: 10; }
    .material-item { display: flex; justify-content: space-between; padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
    .material-item:hover { background: #f0f0f0; }
    .slider-label-group { display: flex; justify-content: space-between; font-size: 0.85rem; color: #666; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header"><h1>ðŸ”§ Estimador Profesional</h1><p>Golden Charge Electrician Company</p></div>
    <div id="login" style="text-align:center;">
      <input type="password" id="password" placeholder="ContraseÃ±a" style="padding:12px;border-radius:8px;border:1px solid #ddd;"/>
      <button onclick="checkPassword()" class="btn" style="width:auto;padding:12px 20px;">Entrar</button>
    </div>
    <div id="app" class="app">
      <div id="quoteForm">
        <div class="section">
          <h3 class="section-title"><i class="fas fa-file-alt"></i> Datos del Cliente y Proyecto</h3>
          <input type="text" id="clientName" class="form-control" placeholder="Nombre del Cliente">
          <input type="text" id="clientAddress" class="form-control" placeholder="DirecciÃ³n del Proyecto" style="margin-top:10px;">
          <select id="city" class="form-control" style="margin-top:10px;"></select>
          <select id="projectType" class="form-control" style="margin-top:10px;"></select>
        </div>
        <div class="section">
          <h3 class="section-title"><i class="fas fa-users-cog"></i> Equipo y Tarifas por Hora</h3>
          <div class="form-group">
            <label for="contractorRate">Tu Tarifa por Hora: $<output id="contractorRateValue">0</output>/hr</label>
            <input type="range" id="contractorRate" class="form-control">
            <div class="slider-label-group"><span id="contractorRateMin">$0</span><span id="contractorRateMax">$0</span></div>
          </div><hr>
          <div class="form-group">
            <label>NÃºmero de Ayudantes:</label>
            <div class="controls"><button type="button" onclick="updateHelper(-1)">âˆ’</button><span id="helperCount">1</span><button type="button" onclick="updateHelper(1)">+</button></div>
          </div>
          <div class="form-group" id="helperRateSection">
            <label for="helperRate">Tarifa por Hora (Ayudante): $<output id="helperRateValue">0</output>/hr</label>
            <input type="range" id="helperRate" class="form-control">
            <div class="slider-label-group"><span id="helperRateMin">$0</span><span id="helperRateMax">$0</span></div>
          </div><hr>
          <div class="form-group">
            <label>Horas estimadas de trabajo:</label>
            <input type="number" id="hours" value="8" min="1" class="form-control" />
          </div>
        </div>
        <div class="section">
          <h3 class="section-title"><i class="fas fa-sliders-h"></i> Cliente y Ajustes de Precio</h3>
          <select id="clientType" class="form-control"></select>
          <div class="form-group" id="contractorDiscountSection" style="display:none;margin-top:10px;">
            <label>Descuento para Contratista: <output id="contractorDiscountValue">15</output>%</label>
            <input type="range" id="contractorDiscount" min="10" max="30" value="15" class="form-control">
          </div>
          <div class="form-group" style="margin-top:10px;">
            <label>Markup de Materiales: <output id="markupValue">30</output>%</label>
            <input type="range" id="materialMarkup" min="25" max="55" value="30" class="form-control">
          </div>
        </div>
        <div class="section">
          <h3 class="section-title"><i class="fas fa-box"></i> Materiales</h3>
          <input type="text" id="materialSearch" class="form-control" placeholder="Buscar materiales...">
          <div id="searchResults" class="search-results"></div>
          <div id="selectedMaterialsList" style="margin-top:15px;"></div>
        </div>
        <div style="text-align:center;">
          <button type="button" class="btn" onclick="calculateQuote()">ðŸ“Š Calcular CotizaciÃ³n</button>
          <button type="button" class="btn btn-pdf" id="exportPdfBtn" onclick="generatePDF()" disabled>ðŸ“„ Exportar a PDF</button>
        </div>
      </div>
      <div id="results" class="section" style="display:none;margin-top:20px;"></div>
    </div>
  </div>

  <script>
    let helperCount = 1, allMaterials = [], selectedMaterials = [], laborRates = {}, permits = {}, lastQuoteData = null;
    const salesTaxRates = { "Fremont": 0.1025, "San Francisco": 0.0863, "Oakland": 0.1025, "San Jose": 0.0938, "Hayward": 0.1075, "Berkeley": 0.1025, "Richmond": 0.0925, "Sunnyvale": 0.0913, "Palo Alto": 0.0913, "Concord": 0.0925, "Daly City": 0.0938, "San Mateo": 0.0963, "Walnut Creek": 0.0925 };

    function checkPassword() {
      if (document.getElementById('password').value === 'GoldenCharge2025!') {
        localStorage.setItem('estimatorAccess', 'true');
        document.getElementById('login').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        initializeApp();
      }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('estimatorAccess') === 'true') {
        document.getElementById('login').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        initializeApp();
      }
    });
    
    async function initializeApp() {
      const basePath = '/data/';
      try {
        const [laborRes, materialsRes, permitsRes] = await Promise.all([
          fetch(basePath + 'labor_rates.json'),
          fetch(basePath + 'materials_prices.json'),
          fetch(basePath + 'permits.json')
        ]);
        if (!laborRes.ok || !materialsRes.ok || !permitsRes.ok) throw new Error("No se pudo cargar uno de los archivos de datos. Verifica las rutas.");
        laborRates = await laborRes.json();
        const prices = await materialsRes.json();
        permits = await permitsRes.json();

        allMaterials = Object.entries(prices).flatMap(([category, items]) => 
          Object.entries(items).map(([name, price]) => ({ id: name, name, price }))
        );
        
        populateDropdowns();
        setupEventListeners();
        updateRateSliders(document.getElementById('city').value);
      } catch (e) {
        alert(`Error fatal al cargar los datos: ${e.message}`);
      }
    }

    function populateDropdowns() {
      const citySelect = document.getElementById('city');
      citySelect.innerHTML = Object.keys(laborRates).map(city => `<option value="${city}">${city}</option>`).join('');
      
      const projectTypeSelect = document.getElementById('projectType');
      const projectTypes = { "service-call": "Llamada de Servicio / DiagnÃ³stico", "panel": "Upgrade de Panel Principal", "ev": "InstalaciÃ³n de Cargador EV", "new": "InstalaciÃ³n de Luces / Circuito Nuevo" };
      projectTypeSelect.innerHTML = Object.entries(projectTypes).map(([key, value]) => `<option value="${key}">${value}</option>`).join('');
      
      const clientTypeSelect = document.getElementById('clientType');
      clientTypeSelect.innerHTML = '<option value="homeowner">Cliente Final</option><option value="contractor">Contratista General</option>';
    }

    function setupEventListeners() {
      document.getElementById('city').addEventListener('change', e => updateRateSliders(e.target.value));
      document.getElementById('materialSearch').addEventListener('input', handleMaterialSearch);
      document.getElementById('clientType').addEventListener('change', e => {
        document.getElementById('contractorDiscountSection').style.display = e.target.value === 'contractor' ? 'block' : 'none';
      });
      ['contractorRate', 'helperRate', 'contractorDiscount', 'materialMarkup'].forEach(id => {
        const slider = document.getElementById(id);
        const output = document.getElementById(id + 'Value');
        if(slider && output) slider.oninput = () => output.textContent = slider.value;
      });
    }

    function updateRateSliders(city) {
      if (!laborRates[city]) return;
      const rates = laborRates[city].labor_rate;
      updateSliderUI('contractorRate', Math.round(rates.contractor_c10 * 0.85), Math.round(rates.contractor_c10 * 1.20), rates.contractor_c10);
      updateSliderUI('helperRate', Math.round(rates.helper * 0.90), Math.round(rates.helper * 1.25), rates.helper);
    }
    
    function updateSliderUI(id, min, max, value) {
      const slider = document.getElementById(id), output = document.getElementById(id + 'Value'), minLabel = document.getElementById(id + 'Min'), maxLabel = document.getElementById(id + 'Max');
      if (!slider || !output || !minLabel || !maxLabel) return;
      slider.min = min; slider.max = max; slider.value = value;
      output.textContent = value;
      minLabel.textContent = `$${min}`; maxLabel.textContent = `$${max}`;
    }

    function updateHelper(change) {
      if (helperCount + change >= 0 && helperCount + change <= 10) {
        helperCount += change;
        document.getElementById('helperCount').textContent = helperCount;
        document.getElementById('helperRateSection').style.display = helperCount > 0 ? 'block' : 'none';
      }
    }

    function handleMaterialSearch(e) {
      const searchTerm = e.target.value.toLowerCase();
      const resultsContainer = document.getElementById('searchResults');
      if (searchTerm.length < 2) { resultsContainer.style.display = 'none'; return; }
      const filtered = allMaterials.filter(m => m.name.toLowerCase().includes(searchTerm)).slice(0, 50);
      resultsContainer.innerHTML = filtered.length ? filtered.map(m => `<div class="material-item" onclick="addItemToQuote('${m.id}')"><span>${m.name}</span><span>$${m.price.toFixed(2)}</span></div>`).join('') : '<div class="material-item">No se encontraron materiales</div>';
      resultsContainer.style.display = 'block';
    }
    
    function addItemToQuote(id) {
      const material = allMaterials.find(m => m.id === id);
      if (!material) return;
      const existing = selectedMaterials.find(m => m.id === id);
      if (existing) { existing.qty++; } else { selectedMaterials.push({ ...material, qty: 1 }); }
      updateSelectedMaterialsList();
      document.getElementById('materialSearch').value = '';
      document.getElementById('searchResults').style.display = 'none';
    }
    
    function updateSelectedMaterialsList() {
      const container = document.getElementById('selectedMaterialsList');
      if (selectedMaterials.length === 0) { container.innerHTML = ''; return; }
      let total = 0;
      const rows = selectedMaterials.map((m, i) => {
        total += m.qty * m.price;
        return `<tr><td>${m.name}</td><td><input type="number" value="${m.qty}" min="1" onchange="updateQty(${i}, this.value)" style="width:60px;"></td><td>$${(m.qty * m.price).toFixed(2)}</td><td><button type="button" onclick="removeMaterial(${i})" style="background:red;color:white;border:0;padding:5px;">X</button></td></tr>`;
      }).join('');
      container.innerHTML = `<table><thead><tr><th>Material</th><th>Cant.</th><th>Total</th><th></th></tr></thead><tbody>${rows}</tbody><tfoot><tr><td colspan="2"><strong>Costo Base Materiales</strong></td><td colspan="2"><strong>$${total.toFixed(2)}</strong></td></tr></tfoot></table>`;
    }

    const updateQty = (i, qty) => { selectedMaterials[i].qty = Math.max(1, parseFloat(qty) || 1); updateSelectedMaterialsList(); };
    const removeMaterial = (i) => { selectedMaterials.splice(i, 1); updateSelectedMaterialsList(); };
    
    function getPermitCost(key, city) {
      return permits[city]?.[key] || permits[city]?.['new'] || 220;
    }

    function calculateQuote() {
      const city = document.getElementById('city').value, hours = parseFloat(document.getElementById('hours').value) || 0;
      const contractorRate = parseFloat(document.getElementById('contractorRate').value), helperRate = parseFloat(document.getElementById('helperRate').value);
      const markupPercent = parseFloat(document.getElementById('materialMarkup').value) / 100, clientType = document.getElementById('clientType').value;
      const projectType = document.getElementById('projectType').value, permitCost = getPermitCost(projectType, city);
      const taxRate = salesTaxRates[city] || 0.095;
      const laborSell = (hours * contractorRate) + (hours * helperCount * helperRate);
      const materialBase = selectedMaterials.reduce((acc, m) => acc + (m.qty * m.price), 0);
      const materialSell = materialBase * (1 + markupPercent);
      const salesTax = materialSell * taxRate;
      let subtotal = laborSell + materialSell + salesTax + permitCost, discountAmount = 0;
      if (clientType === 'contractor') {
        discountAmount = subtotal * (parseFloat(document.getElementById('contractorDiscount').value) / 100);
      }
      const finalPrice = subtotal - discountAmount;
      lastQuoteData = { city, finalPrice, laborSell, materialSell, salesTax, permitCost, discountAmount, clientType };
      displayResult(lastQuoteData);
    }

    function displayResult(data) {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = `<h3>Resumen</h3><table>
        <tr><td>Mano de Obra</td><td>$${data.laborSell.toFixed(2)}</td></tr>
        <tr><td>Materiales (con markup)</td><td>$${data.materialSell.toFixed(2)}</td></tr>
        <tr><td>Impuesto sobre Venta (${(salesTaxRates[data.city]*100).toFixed(2)}%)</td><td>$${data.salesTax.toFixed(2)}</td></tr>
        <tr><td>Permisos e InspecciÃ³n</td><td>$${data.permitCost.toFixed(2)}</td></tr>
        ${data.discountAmount > 0 ? `<tr><td>Descuento Contratista</td><td style="color:red;">-$${data.discountAmount.toFixed(2)}</td></tr>` : ''}
        <tr class="total-row" style="font-size:1.2rem;"><td><strong>Precio Final Estimado</strong></td><td><strong>$${data.finalPrice.toFixed(2)}</strong></td></tr>
      </table>`;
      resultsDiv.style.display = 'block';
      document.getElementById('exportPdfBtn').disabled = false;
    }
    
    function generatePDF() {
      if (!lastQuoteData) { alert("Primero calcula una cotizaciÃ³n."); return; }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const clientName = document.getElementById('clientName').value || 'Cliente Valioso';
      const city = document.getElementById('city').value;
      const date = new Date().toLocaleDateString('es-MX');

      // TÃ­tulo y Cabecera
      doc.setFontSize(20).setTextColor('#0A2463').text('Golden Charge Electrician Co.', 105, 20, { align: 'center' });
      doc.setFontSize(10).setTextColor(100).text('COTIZACIÃ“N DE PROYECTO', 105, 28, { align: 'center' });
      
      // InformaciÃ³n del Cliente y Fecha
      doc.setFontSize(10).text(`PARA: ${clientName}`, 14, 40);
      doc.text(`CIUDAD: ${city}`, 14, 45);
      doc.text(`FECHA: ${date}`, 140, 40);

      // Tabla de Costos
      const tableBody = [
        ['Mano de Obra', `$${lastQuoteData.laborSell.toFixed(2)}`],
        ['Materiales (con markup)', `$${lastQuoteData.materialSell.toFixed(2)}`],
        ['Impuesto sobre Venta', `$${lastQuoteData.salesTax.toFixed(2)}`],
        ['Permisos e InspecciÃ³n', `$${lastQuoteData.permitCost.toFixed(2)}`],
      ];
      if (lastQuoteData.discountAmount > 0) {
        tableBody.push(['Descuento Contratista', `-$${lastQuoteData.discountAmount.toFixed(2)}`]);
      }

      doc.autoTable({
        startY: 55,
        head: [['Concepto', 'Precio']],
        body: tableBody,
        foot: [['Precio Final Estimado', `$${lastQuoteData.finalPrice.toFixed(2)}`]],
        theme: 'grid',
        headStyles: { fillColor: [10, 36, 99] },
        footStyles: { fillColor: [230, 230, 230], textColor: 0, fontStyle: 'bold' }
      });
      
      doc.save(`cotizacion-${clientName.replace(/\s+/g, '-')}.pdf`);
    }
  </script>
</body>
</html>
