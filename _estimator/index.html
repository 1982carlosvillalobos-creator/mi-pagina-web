<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Golden Charge - Estimador Profesional</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.legacy.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf-autotable.min.js"></script>
  <style>
    :root{
      --gold:#ffd144;
      --dark:#0b2545;
      --muted:#6b7280;
      --bg:#f5f7fb;
      --card:#ffffff;
      --radius:12px;
      --shadow: 0 8px 24px rgba(11,37,69,0.06);
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{background:var(--bg);color:#1f2937;padding:28px;}
    .container{max-width:1080px;margin:0 auto;}
    .header{display:flex;align-items:center;gap:18px;margin-bottom:20px;}
    .brand{background:linear-gradient(135deg,var(--gold),#fbc02d);padding:14px 18px;border-radius:12px;color:var(--dark);font-weight:800;box-shadow:var(--shadow);display:flex;flex-direction:column;align-items:center;}
    .brand h1{font-size:1.1rem;margin-bottom:2px;}
    .brand small{font-size:0.8rem;color:rgba(11,37,69,0.85)}
    .header-right{flex:1;padding-left:10px;}
    .card{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);border:1px solid #e6eef8;}
    .login-row{display:flex;gap:10px;align-items:center;justify-content:center;margin-bottom:18px;}
    input[type="password"]{padding:10px 12px;border-radius:10px;border:1px solid #d1d5db;width:260px;}
    .btn{background:var(--dark);color:var(--gold);padding:10px 14px;border-radius:999px;border:0;font-weight:700;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease;}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(11,37,69,0.12)}
    .btn:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
    form .section{margin-bottom:16px}
    .section-title{display:flex;align-items:center;gap:10px;margin-bottom:12px;font-weight:700;color:var(--dark);font-size:1.05rem}
    .form-control{width:100%;padding:10px;border-radius:10px;border:1px solid #e6eef8;}
    label{display:block;margin-bottom:6px;color:var(--muted);font-weight:600}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .controls{display:flex;align-items:center;gap:8px}
    .controls button{width:36px;height:36px;border-radius:50%;border:0;background:var(--dark);color:var(--gold);cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th, td{padding:10px;border:1px solid #eef3fb;text-align:left;font-size:0.95rem}
    th{background:#f0f6ff;color:var(--dark);font-weight:700}
    tbody tr:nth-child(even){background:#fbfdff}
    .muted{color:var(--muted);font-size:0.9rem}
    .search-results{position:absolute;left:0;right:0;top:100%;background:white;border:1px solid #e6eef8;border-radius:8px;max-height:240px;overflow:auto;z-index:30}
    .material-item{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #f1f5f9;cursor:pointer}
    .material-item:hover{background:#fbfbfe}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:0.9rem}
    @media (max-width:900px){ .row{flex-direction:column} .login-row{flex-direction:column} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand card">
        <h1>Golden Charge</h1>
        <small>Electrician Company</small>
      </div>
      <div class="header-right">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:800;color:var(--dark)">Estimador Profesional</div>
            <div class="muted">Crea cotizaciones claras y exporta PDF con desglose</div>
          </div>
          <div style="text-align:right" class="muted">
            <div>Tel: 510-221-1258</div>
            <div>carlos.villalobos@goldencharge.net</div>
            <div>www.goldencharge.net</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div id="login" class="login-row">
        <input type="password" id="password" placeholder="ContraseÃ±a (Ingresa para entrar)" />
        <button class="btn" onclick="checkPassword()">Entrar</button>
      </div>

      <div id="app" style="display:none;">
        <form id="quoteForm" onsubmit="return false;">
          <div class="section">
            <div class="section-title"><i class="fas fa-file-alt"></i> Datos del Cliente y Proyecto</div>
            <div class="row">
              <div class="col">
                <label>Nombre del Cliente</label>
                <input class="form-control" id="clientName" placeholder="Ej: Juan PÃ©rez">
              </div>
              <div class="col">
                <label>DirecciÃ³n del Proyecto</label>
                <input class="form-control" id="clientAddress" placeholder="Calle, nÃºmero, colonia">
              </div>
            </div>
            <div style="margin-top:10px" class="row">
              <div class="col">
                <label>Ciudad del Proyecto</label>
                <select id="city" class="form-control"></select>
              </div>
              <div class="col">
                <label>Tipo de Proyecto</label>
                <select id="projectType" class="form-control"></select>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-title"><i class="fas fa-users-cog"></i> Mano de obra y equipo</div>
            <div class="row">
              <div class="col">
                <label>Tu tarifa por hora: $<output id="contractorRateValue">0</output>/hr</label>
                <input type="range" id="contractorRate" class="form-control">
                <div style="display:flex;justify-content:space-between;font-size:0.85rem;color:var(--muted)"><span id="contractorRateMin">$0</span><span id="contractorRateMax">$0</span></div>
              </div>
              <div class="col">
                <label>NÃºmero de ayudantes</label>
                <div class="controls" style="justify-content:flex-start;">
                  <button type="button" onclick="updateHelper(-1)">âˆ’</button>
                  <div style="padding:0 8px;font-weight:800" id="helperCount">1</div>
                  <button type="button" onclick="updateHelper(1)">+</button>
                </div>
                <div id="helperRateSection" style="margin-top:8px">
                  <label>Tarifa por ayudante: $<output id="helperRateValue">0</output>/hr</label>
                  <input type="range" id="helperRate" class="form-control">
                  <div style="display:flex;justify-content:space-between;font-size:0.85rem;color:var(--muted)"><span id="helperRateMin">$0</span><span id="helperRateMax">$0</span></div>
                </div>
              </div>
            </div>

            <div style="margin-top:12px">
              <label>Horas estimadas</label>
              <input type="number" id="hours" class="form-control" value="8" min="1">
            </div>
          </div>

          <div class="section">
            <div class="section-title"><i class="fas fa-sliders-h"></i> Ajustes</div>
            <div class="row">
              <div class="col">
                <label>Tipo de cliente</label>
                <select id="clientType" class="form-control"></select>
              </div>
              <div class="col">
                <div id="contractorDiscountSection" style="display:none">
                  <label>Descuento para Contratista: <output id="contractorDiscountValue">15</output>%</label>
                  <input type="range" id="contractorDiscount" class="form-control" min="10" max="30" value="15">
                </div>
                <div style="margin-top:8px">
                  <label>Markup de materiales: <output id="materialMarkupValue">30</output>%</label>
                  <input type="range" id="materialMarkup" class="form-control" min="25" max="55" value="30">
                </div>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-title"><i class="fas fa-box"></i> Materiales</div>
            <div style="position:relative">
              <label>BÃºsqueda de materiales</label>
              <input id="materialSearch" class="form-control" placeholder="Ej: romex, outlet, breaker...">
              <div id="searchResults" class="search-results" style="display:none"></div>
            </div>

            <div style="margin-top:12px">
              <label>Materiales Seleccionados</label>
              <div id="selectedMaterialsList"></div>
            </div>
          </div>

          <div style="text-align:center;margin-top:14px">
            <button type="button" class="btn" onclick="calculateQuote()">ðŸ“Š Calcular CotizaciÃ³n</button>
            <button type="button" class="btn" id="exportPdfBtn" onclick="generatePDF()" disabled style="margin-left:10px;background:#0b5bd7">ðŸ“„ Exportar a PDF</button>
          </div>
        </form>

        <div id="results" style="display:none;margin-top:18px" class="card">
          <h3 style="margin-bottom:8px">Resumen de la CotizaciÃ³n</h3>
          <div id="resultsContent"></div>
        </div>
      </div>
    </div>

    <footer>Golden Charge Electrician Company â€¢ Tel 510-221-1258 â€¢ carlos.villalobos@goldencharge.net â€¢ www.goldencharge.net</footer>
  </div>

<script>
/* --- Variables --- */
let helperCount = 1, allMaterials = [], selectedMaterials = [], laborRates = {}, permits = {}, lastQuoteData = null;
const salesTaxRates = { "Fremont": 0.1025, "San Francisco": 0.0863, "Oakland": 0.1025, "San Jose": 0.0938, "Hayward": 0.1075, "Berkeley": 0.1025, "Richmond": 0.0925, "Sunnyvale": 0.0913, "Palo Alto": 0.0913, "Concord": 0.0925, "Daly City": 0.0938, "San Mateo": 0.0963, "Walnut Creek": 0.0925 };

/* --- Acceso --- */
function checkPassword(){
  if(document.getElementById('password').value === 'GoldenCharge2025!'){
    localStorage.setItem('estimatorAccess','true');
    document.getElementById('login').style.display='none';
    document.getElementById('app').style.display='block';
    initializeApp();
  } else {
    alert('ContraseÃ±a incorrecta.');
  }
}
document.addEventListener('DOMContentLoaded',() => {
  if(localStorage.getItem('estimatorAccess') === 'true'){
    document.getElementById('login').style.display='none';
    document.getElementById('app').style.display='block';
    initializeApp();
  }
});

/* --- InicializaciÃ³n --- */
async function initializeApp(){
  const basePath = '/data/';
  try{
    const [laborRes, materialsRes, permitsRes] = await Promise.all([
      fetch(basePath + 'labor_rates.json'),
      fetch(basePath + 'materials_prices.json'),
      fetch(basePath + 'permits.json')
    ]);
    if(!laborRes.ok || !materialsRes.ok || !permitsRes.ok) throw new Error('No se pudieron cargar archivos de datos.');
    laborRates = await laborRes.json();
    const materialsJson = await materialsRes.json();
    permits = await permitsRes.json();
    allMaterials = Object.entries(materialsJson).flatMap(([_, group]) =>
      Object.entries(group).map(([name, price]) => ({ id:name, name, price: parseFloat(price) }))
    );
    populateDropdowns();
    setupEventListeners();
    updateRateSliders(document.getElementById('city').value);
  } catch(e){
    alert('Error al cargar datos: ' + e.message);
  }
}

/* --- Poblado de selects --- */
function populateDropdowns(){
  const citySelect = document.getElementById('city');
  citySelect.innerHTML = Object.keys(laborRates).map(c => `<option value="${c}">${c}</option>`).join('');
  const projectTypes = { "service-call": "Llamada de Servicio / DiagnÃ³stico", "panel": "Upgrade de Panel Principal (100A-200A)", "rewire-full-house": "Recableado Completo de Casa (Rewire)", "ev": "InstalaciÃ³n de Cargador EV (Nivel 2, 50A)", "new": "InstalaciÃ³n de Luces Empotradas (Recessed)", "subpanel-install": "InstalaciÃ³n de Subpanel", "kitchen-remodel": "RemodelaciÃ³n ElÃ©ctrica de Cocina", "bathroom-remodel": "RemodelaciÃ³n ElÃ©ctrica de BaÃ±o", "outlet-switch-install": "Instalar/Mover Enchufes e Interruptores", "landscape-lighting": "IluminaciÃ³n de JardÃ­n (Landscape)", "commercial-tio": "Mejoras para Inquilinos Comerciales (T.I.)", "low-voltage": "InstalaciÃ³n de Bajo Voltaje (Datos/Ethernet)", "generator-transfer-switch": "InstalaciÃ³n de Generador y Transfer Switch", "pool-spa-hookup": "ConexiÃ³n ElÃ©ctrica para Piscina/Spa", "troubleshooting": "ResoluciÃ³n de Problemas ElÃ©ctricos" };
  document.getElementById('projectType').innerHTML = Object.entries(projectTypes).map(([k,v]) => `<option value="${k}">${v}</option>`).join('');
  document.getElementById('clientType').innerHTML = '<option value="homeowner">Cliente Final</option><option value="contractor">Contratista General</option>';
}

/* --- Listeners --- */
function setupEventListeners(){
  document.getElementById('city').addEventListener('change', e => updateRateSliders(e.target.value));
  document.getElementById('materialSearch').addEventListener('input', handleMaterialSearch);
  document.getElementById('clientType').addEventListener('change', e => {
    document.getElementById('contractorDiscountSection').style.display = e.target.value === 'contractor' ? 'block' : 'none';
  });
  ['contractorRate','helperRate','contractorDiscount','materialMarkup'].forEach(id => {
    const slider = document.getElementById(id), output = document.getElementById(id + 'Value');
    if(slider && output) slider.oninput = () => output.textContent = slider.value;
  });
  document.addEventListener('click', e => {
    if(!e.target.closest('.search-results') && !e.target.closest('#materialSearch'))
      document.getElementById('searchResults').style.display = 'none';
  });
}

/* --- ActualizaciÃ³n sliders --- */
function updateRateSliders(city){
  if(!laborRates[city]) return;
  const rates = laborRates[city].labor_rate;
  updateSliderUI('contractorRate', Math.round(rates.contractor_c10 * 0.85), Math.round(rates.contractor_c10 * 1.20), rates.contractor_c10);
  updateSliderUI('helperRate', Math.round(rates.helper * 0.90), Math.round(rates.helper * 1.25), rates.helper);
}
function updateSliderUI(id, min, max, value){
  const slider = document.getElementById(id), output = document.getElementById(id + 'Value'), minLabel = document.getElementById(id + 'Min'), maxLabel = document.getElementById(id + 'Max');
  if(!slider || !output) return;
  slider.min = min; slider.max = max; slider.value = value;
  output.textContent = value;
  if(minLabel) minLabel.textContent = `$${min}`;
  if(maxLabel) maxLabel.textContent = `$${max}`;
}

/* --- Helpers --- */
function updateHelper(change){
  if(helperCount + change >= 0 && helperCount + change <= 10){
    helperCount += change;
    document.getElementById('helperCount').textContent = helperCount;
    document.getElementById('helperRateSection').style.display = helperCount > 0 ? 'block' : 'none';
  }
}

/* --- Materiales --- */
function handleMaterialSearch(e){
  const term = e.target.value.toLowerCase();
  const results = document.getElementById('searchResults');
  if(term.length < 2){ results.style.display = 'none'; return; }
  const filtered = allMaterials.filter(m => m.name.toLowerCase().includes(term)).slice(0, 50);
  results.innerHTML = filtered.length ? filtered.map(m => `<div class="material-item" onclick="addItemToQuote('${m.id}')"><span>${m.name}</span><span>$${m.price.toFixed(2)}</span></div>`).join('') : '<div class="material-item">No se encontraron materiales</div>';
  results.style.display = 'block';
}
function addItemToQuote(id){
  const material = allMaterials.find(m => m.id === id);
  if(!material) return;
  const existing = selectedMaterials.find(m => m.id === id);
  if(existing){ existing.qty++; } else { selectedMaterials.push({ ...material, qty: 1 }); }
  updateSelectedMaterialsList();
  document.getElementById('materialSearch').value = '';
  document.getElementById('searchResults').style.display = 'none';
}
function updateSelectedMaterialsList(){
  const c = document.getElementById('selectedMaterialsList');
  if(selectedMaterials.length === 0){ c.innerHTML = '<div class="muted">No hay materiales seleccionados</div>'; return; }
  let total = 0;
  const rows = selectedMaterials.map((m,i) => {
    total += m.qty * m.price;
    return `<tr><td>${m.name}</td><td><input type="number" value="${m.qty}" min="1" onchange="updateQty(${i}, this.value)" style="width:60px;padding:5px"></td><td>$${m.price.toFixed(2)}</td><td>$${(m.qty*m.price).toFixed(2)}</td><td><button onclick="removeMaterial(${i})" style="background:red;color:white;border:0;padding:5px 8px;border-radius:6px">X</button></td></tr>`;
  }).join('');
  c.innerHTML = `<table><thead><tr><th>Material</th><th>Cant.</th><th>Precio Unit.</th><th>Total</th><th></th></tr></thead><tbody>${rows}</tbody><tfoot><tr><td colspan="3"><strong>Costo Base Materiales</strong></td><td colspan="2"><strong>$${total.toFixed(2)}</strong></td></tr></tfoot></table>`;
}
function updateQty(i, qty){ selectedMaterials[i].qty = Math.max(1, parseFloat(qty) || 1); updateSelectedMaterialsList(); }
function removeMaterial(i){ selectedMaterials.splice(i,1); updateSelectedMaterialsList(); }

/* --- Permisos --- */
function getPermitCost(key, city){
  return permits[city]?.[key] || permits[city]?.['new'] || 220;
}

/* --- CÃ¡lculo de cotizaciÃ³n --- */
function calculateQuote(){
  const city = document.getElementById('city').value;
  const hours = parseFloat(document.getElementById('hours').value) || 0;
  const contractorRate = parseFloat(document.getElementById('contractorRate').value) || 0;
  const helperRate = parseFloat(document.getElementById('helperRate').value) || 0;
  const markupPercent = parseFloat(document.getElementById('materialMarkup').value)/100 || 0;
  const clientType = document.getElementById('clientType').value;
  const projectType = document.getElementById('projectType').value;
  const permitCost = getPermitCost(projectType, city);
  const taxRate = salesTaxRates[city] || 0.095;

  const laborSell = (hours * contractorRate) + (hours * helperCount * helperRate);
  const materialBase = selectedMaterials.reduce((acc,m) => acc + (m.qty * m.price), 0);
  const materialSell = materialBase * (1 + markupPercent);
  const salesTax = materialSell * taxRate;

  let subtotal = laborSell + materialSell + salesTax + permitCost;
  let discountAmount = 0;
  if(clientType === 'contractor'){
    discountAmount = subtotal * (parseFloat(document.getElementById('contractorDiscount').value)/100);
  }
  const finalPrice = subtotal - discountAmount;

  lastQuoteData = { city, laborSell, materialSell, salesTax, permitCost, discountAmount, finalPrice, materialBase, markupPercent };
  displayResult(lastQuoteData);
}

/* --- Mostrar resultados --- */
function displayResult(data){
  const el = document.getElementById('resultsContent');
  el.innerHTML = `<table>
    <tr><td>Mano de obra</td><td style="text-align:right">$${data.laborSell.toFixed(2)}</td></tr>
    <tr><td>Materiales (con markup ${Math.round(data.markupPercent*100)}%)</td><td style="text-align:right">$${data.materialSell.toFixed(2)}</td></tr>
    <tr><td>Impuesto sobre venta (${((salesTaxRates[data.city]||0.095)*100).toFixed(2)}%)</td><td style="text-align:right">$${data.salesTax.toFixed(2)}</td></tr>
    <tr><td>Permisos e inspecciÃ³n</td><td style="text-align:right">$${data.permitCost.toFixed(2)}</td></tr>
    ${data.discountAmount > 0 ? `<tr><td style="color:#ef4444">Descuento Contratista</td><td style="text-align:right;color:#ef4444">-$${data.discountAmount.toFixed(2)}</td></tr>` : ''}
    <tr style="font-size:1.15rem;background:#f8fafc"><td><strong>Precio Final Estimado</strong></td><td style="text-align:right"><strong>$${data.finalPrice.toFixed(2)}</strong></td></tr>
  </table>
  <div style="margin-top:10px" class="muted">* Incluye materiales, mano de obra, permisos e impuestos</div>`;
  document.getElementById('results').style.display = 'block';
  document.getElementById('exportPdfBtn').disabled = false;
}

/* --- PDF con logo --- */
async function generatePDF(){
  const clientName = (document.getElementById('clientName').value || '').trim();
  const clientAddress = (document.getElementById('clientAddress').value || '').trim();
  if(!clientName || !clientAddress){ alert('Por favor ingresa el nombre y la direcciÃ³n del cliente antes de exportar a PDF.'); return; }
  if(!lastQuoteData){ alert('Primero calcula una cotizaciÃ³n.'); return; }

  const doc = new jsPDF({unit:'pt', format:'a4'});
  const leftMargin = 40;
  const pageWidth = doc.internal.pageSize.getWidth();

  const logoUrl = "https://pub-a9f35b2b86db4656b16e6e97d0d62544.r2.dev/logo.png";
  const img = await fetch(logoUrl).then(r=>r.blob()).then(blob=>{
    return new Promise(res=>{
      const reader = new FileReader();
      reader.onload = ()=>res(reader.result);
      reader.readAsDataURL(blob);
    });
  });

  doc.addImage(img, 'PNG', leftMargin, 30, 80, 80);
  doc.setFontSize(14); doc.setTextColor(10,36,69); doc.setFont('helvetica','bold');
  doc.text('Golden Charge Electrician Company', pageWidth - leftMargin, 60, { align: 'right' });
  doc.setFontSize(9); doc.setFont('helvetica','normal');
  doc.text('Tel: 510-221-1258', pageWidth - leftMargin, 76, { align: 'right' });
  doc.text('carlos.villalobos@goldencharge.net', pageWidth - leftMargin, 90, { align: 'right' });
  doc.text('www.goldencharge.net', pageWidth - leftMargin, 104, { align: 'right' });

  doc.setFontSize(18); doc.setFont('helvetica','bold'); doc.setTextColor(10,36,69);
  doc.text('COTIZACIÃ“N DE PROYECTO', pageWidth/2, 140, { align: 'center' });

  const dateStr = new Date().toLocaleDateString('es-MX');
  doc.setFontSize(10); doc.setFont('helvetica','normal');
  doc.text(`Para: ${clientName}`, leftMargin, 170);
  doc.text(`DirecciÃ³n: ${clientAddress}`, leftMargin, 185);
  doc.text(`Ciudad: ${document.getElementById('city').value}`, leftMargin, 200);
  doc.text(`Fecha: ${dateStr}`, pageWidth - leftMargin - 120, 170);
  doc.setFontSize(10); doc.setTextColor(80);
  doc.text('Incluye materiales, mano de obra, permisos e impuestos.', leftMargin, 220);

  const summaryBody = [
    ['Mano de Obra', `$${lastQuoteData.laborSell.toFixed(2)}`],
    ['Materiales (con markup)', `$${lastQuoteData.materialSell.toFixed(2)}`],
    ['Impuesto sobre Venta', `$${lastQuoteData.salesTax.toFixed(2)}`],
    ['Permisos e InspecciÃ³n', `$${lastQuoteData.permitCost.toFixed(2)}`]
  ];
  if(lastQuoteData.discountAmount > 0) summaryBody.push(['Descuento Contratista', `-$${lastQuoteData.discountAmount.toFixed(2)}`]);
  doc.autoTable({
    startY: 240,
    head: [['Concepto','Precio']],
    body: summaryBody,
    foot: [['Precio Final Estimado', `$${lastQuoteData.finalPrice.toFixed(2)}`]],
    theme: 'grid',
    styles: { fontSize: 10 },
    headStyles: { fillColor: [10,36,69], textColor: 255 },
    footStyles: { fillColor: [240,240,240], fontStyle: 'bold' }
  });

  let y = doc.lastAutoTable.finalY + 20;
  doc.setFont('helvetica','bold'); doc.setTextColor(10,36,69);
  doc.text('Detalle de Materiales', leftMargin, y);

  if(selectedMaterials.length){
    const matBody = selectedMaterials.map(m=>[m.name, String(m.qty), `$${m.price.toFixed(2)}`, `$${(m.qty*m.price).toFixed(2)}`]);
    doc.autoTable({
      startY: y+8,
      head: [['Material','Cant.','Precio Unit.','Total']],
      body: matBody,
      theme: 'striped',
      styles: { fontSize: 9.5 },
      headStyles: { fillColor: [230,230,240], textColor: 10 }
    });
    y = doc.lastAutoTable.finalY + 20;
  } else {
    doc.setFont('helvetica','normal'); doc.setTextColor(120); doc.setFontSize(10);
    doc.text('No se agregaron materiales detallados.', leftMargin, y+15);
    y += 40;
  }

  doc.setFontSize(9); doc.setTextColor(100);
  doc.text('Gracias por su preferencia. CotizaciÃ³n vÃ¡lida por 30 dÃ­as.', leftMargin, y+20);

  const safeName = clientName.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9\-]/g,'');
  doc.save(`cotizacion-${safeName || 'cliente'}.pdf`);
}
</script>
</body>
</html>
