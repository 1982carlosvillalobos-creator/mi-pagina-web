<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Golden Charge - Estimador Profesional</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.legacy.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf-autotable.min.js"></script>
  <style>
    :root{
      --gold:#ffd144;
      --dark:#0b2545;
      --muted:#6b7280;
      --bg:#f5f7fb;
      --card:#ffffff;
      --radius:12px;
      --shadow: 0 8px 24px rgba(11,37,69,0.06);
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{background:var(--bg);color:#1f2937;padding:28px;}
    .container{max-width:1080px;margin:0 auto;}
    .header{display:flex;align-items:center;gap:18px;margin-bottom:20px;}
    .brand{background:linear-gradient(135deg,var(--gold),#fbc02d);padding:14px 18px;border-radius:12px;color:var(--dark);font-weight:800;box-shadow:var(--shadow);display:flex;flex-direction:column;align-items:center;}
    .brand h1{font-size:1.1rem;margin-bottom:2px;}
    .brand small{font-size:0.8rem;color:rgba(11,37,69,0.85)}
    .header-right{flex:1;padding-left:10px;}
    .card{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);border:1px solid #e6eef8;}
    .login-row{display:flex;gap:10px;align-items:center;justify-content:center;margin-bottom:18px;}
    input[type="password"]{padding:10px 12px;border-radius:10px;border:1px solid #d1d5db;width:260px;}
    .btn{background:var(--dark);color:var(--gold);padding:10px 14px;border-radius:999px;border:0;font-weight:700;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease;}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(11,37,69,0.12)}
    .btn:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
    form .section{margin-bottom:16px}
    .section-title{display:flex;align-items:center;gap:10px;margin-bottom:12px;font-weight:700;color:var(--dark);font-size:1.05rem}
    .form-control{width:100%;padding:10px;border-radius:10px;border:1px solid #e6eef8;}
    label{display:block;margin-bottom:6px;color:var(--muted);font-weight:600}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .controls{display:flex;align-items:center;gap:8px}
    .controls button{width:36px;height:36px;border-radius:50%;border:0;background:var(--dark);color:var(--gold);cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th, td{padding:10px;border:1px solid #eef3fb;text-align:left;font-size:0.95rem}
    th{background:#f0f6ff;color:var(--dark);font-weight:700}
    tbody tr:nth-child(even){background:#fbfdff}
    .muted{color:var(--muted);font-size:0.9rem}
    .search-results{position:absolute;left:0;right:0;top:100%;background:white;border:1px solid #e6eef8;border-radius:8px;max-height:240px;overflow:auto;z-index:30}
    .material-item{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #f1f5f9;cursor:pointer}
    .material-item:hover{background:#fbfbfe}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:0.9rem}
    @media (max-width:900px){ .row{flex-direction:column} .login-row{flex-direction:column} }
  </style>
</head>
<body>
  <!-- CONTENIDO (igual que antes) -->
  <!-- ... (todo el HTML del cuerpo igual que la versión anterior) ... -->

<script>
/* Código JS igual que antes hasta la función generatePDF */
/* Cambiamos solo generatePDF para agregar logo */

async function generatePDF(){
  const clientName = (document.getElementById('clientName').value || '').trim();
  const clientAddress = (document.getElementById('clientAddress').value || '').trim();
  if(!clientName || !clientAddress){
    alert('Por favor ingresa el nombre y la dirección del cliente antes de exportar a PDF.');
    return;
  }
  if(!lastQuoteData){ alert('Primero calcula una cotización.'); return; }

  const doc = new jsPDF({unit:'pt', format:'a4'});
  const leftMargin = 40;
  const pageWidth = doc.internal.pageSize.getWidth();

  // Descargar logo
  const logoUrl = "https://pub-a9f35b2b86db4656b16e6e97d0d62544.r2.dev/logo.png";
  const img = await fetch(logoUrl).then(r=>r.blob()).then(blob=>{
    return new Promise(res=>{
      const reader = new FileReader();
      reader.onload = ()=>res(reader.result);
      reader.readAsDataURL(blob);
    });
  });

  // Insertar logo
  doc.addImage(img, 'PNG', leftMargin, 30, 80, 80);

  // Header empresa
  doc.setFontSize(14);
  doc.setTextColor(10,36,69);
  doc.setFont('helvetica','bold');
  doc.text('Golden Charge Electrician Company', pageWidth - leftMargin, 60, { align: 'right' });
  doc.setFontSize(9);
  doc.setFont('helvetica','normal');
  doc.text('Tel: 510-221-1258', pageWidth - leftMargin, 76, { align: 'right' });
  doc.text('carlos.villalobos@goldencharge.net', pageWidth - leftMargin, 90, { align: 'right' });
  doc.text('www.goldencharge.net', pageWidth - leftMargin, 104, { align: 'right' });

  // Título
  doc.setFontSize(18);
  doc.setFont('helvetica','bold');
  doc.setTextColor(10,36,69);
  doc.text('COTIZACIÓN DE PROYECTO', pageWidth/2, 140, { align: 'center' });

  const dateStr = new Date().toLocaleDateString('es-MX');
  doc.setFontSize(10);
  doc.setFont('helvetica','normal');
  doc.text(`Para: ${clientName}`, leftMargin, 170);
  doc.text(`Dirección: ${clientAddress}`, leftMargin, 185);
  doc.text(`Ciudad: ${document.getElementById('city').value}`, leftMargin, 200);
  doc.text(`Fecha: ${dateStr}`, pageWidth - leftMargin - 120, 170);

  doc.setFontSize(10);
  doc.setTextColor(80);
  doc.text('Incluye materiales, mano de obra, permisos e impuestos.', leftMargin, 220);

  // Tabla de resumen
  const summaryBody = [
    ['Mano de Obra', `$${lastQuoteData.laborSell.toFixed(2)}`],
    ['Materiales (con markup)', `$${lastQuoteData.materialSell.toFixed(2)}`],
    ['Impuesto sobre Venta', `$${lastQuoteData.salesTax.toFixed(2)}`],
    ['Permisos e Inspección', `$${lastQuoteData.permitCost.toFixed(2)}`]
  ];
  if(lastQuoteData.discountAmount > 0)
    summaryBody.push(['Descuento Contratista', `-$${lastQuoteData.discountAmount.toFixed(2)}`]);

  doc.autoTable({
    startY: 240,
    head: [['Concepto','Precio']],
    body: summaryBody,
    foot: [['Precio Final Estimado', `$${lastQuoteData.finalPrice.toFixed(2)}`]],
    theme: 'grid',
    styles: { fontSize: 10 },
    headStyles: { fillColor: [10,36,69], textColor: 255 },
    footStyles: { fillColor: [240,240,240], fontStyle: 'bold' }
  });

  let y = doc.lastAutoTable.finalY + 20;
  doc.setFont('helvetica','bold');
  doc.setTextColor(10,36,69);
  doc.text('Detalle de Materiales', leftMargin, y);

  if(selectedMaterials.length){
    const matBody = selectedMaterials.map(m=>[m.name, String(m.qty), `$${m.price.toFixed(2)}`, `$${(m.qty*m.price).toFixed(2)}`]);
    doc.autoTable({
      startY: y+8,
      head: [['Material','Cant.','Precio Unit.','Total']],
      body: matBody,
      theme: 'striped',
      styles: { fontSize: 9.5 },
      headStyles: { fillColor: [230,230,240], textColor: 10 }
    });
    y = doc.lastAutoTable.finalY + 20;
  } else {
    doc.setFont('helvetica','normal');
    doc.setTextColor(120);
    doc.setFontSize(10);
    doc.text('No se agregaron materiales detallados.', leftMargin, y+15);
    y += 40;
  }

  doc.setFontSize(9);
  doc.setTextColor(100);
  doc.text('Gracias por su preferencia. Cotización válida por 30 días.', leftMargin, y+20);

  const safeName = clientName.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9\-]/g,'');
  doc.save(`cotizacion-${safeName || 'cliente'}.pdf`);
}
</script>
</body>
</html>
