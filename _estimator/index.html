<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex,nofollow" />
  <title>Golden Charge - Estimador Profesional</title>
  <style>
    :root {
      --gold: #FFD700;
      --dark-blue: #0A2463;
      --light-gray: #f8f9fa;
      --text: #1e1e1e;
      --card-bg: #ffffff;
      --border: #ddd;
      --btn-bg: var(--dark-blue);
      --btn-text: var(--gold);
      --btn-hover: #FFD700;
      --btn-hover-text: var(--dark-blue);
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    body {
      background: var(--light-gray);
      color: var(--text);
      line-height: 1.6;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: var(--dark-blue);
      margin-bottom: 30px;
      font-size: 2rem;
    }
    .login {
      text-align: center;
      margin: 60px 0;
    }
    .login input {
      padding: 12px 16px;
      font-size: 1.2rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      width: 280px;
      margin-right: 10px;
    }
    .login button {
      padding: 12px 20px;
      background: var(--btn-bg);
      color: var(--btn-text);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    .login button:hover {
      background: var(--btn-hover);
      color: var(--btn-hover-text);
    }
    .app {
      display: none;
      background: var(--card-bg);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,.1);
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark-blue);
    }
    .form-group select, .form-group input, .form-control-file {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
    }
    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    .controls button {
      background: var(--dark-blue);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 1.2rem;
      cursor: pointer;
    }
    .controls span {
      font-size: 1.2rem;
      font-weight: bold;
    }
    .markup-control {
      margin: 20px 0;
    }
    .markup-control output {
      font-weight: bold;
      color: var(--dark-blue);
    }
    .btn {
      padding: 14px 25px;
      background: var(--btn-bg);
      color: var(--btn-text);
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-weight: bold;
      margin: 10px 5px;
      transition: 0.3s;
    }
    .btn:hover {
      background: var(--btn-hover);
      color: var(--btn-hover-text);
      transform: translateY(-3px);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border: 1px solid var(--border);
    }
    th {
      background: var(--dark-blue);
      color: var(--gold);
    }
    .total-row {
      font-weight: bold;
      background: #f0f0f0;
    }
    #materialTable {
      margin-top: 10px;
    }
    #materialTable button {
      padding: 5px 10px;
      font-size: 0.9rem;
    }
    #results {
      margin-top: 30px;
      background: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0,0,0,.1);
    }
    .summary {
      margin-top: 20px;
      font-size: 1.1rem;
    }
    .summary strong {
      color: var(--dark-blue);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß Estimador Profesional - Golden Charge</h1>

    <!-- Pantalla de Login -->
    <div id="login" class="login">
      <input type="password" id="password" placeholder="Contrase√±a" />
      <button onclick="checkPassword()">Entrar</button>
    </div>

    <!-- App (solo despu√©s de login) -->
    <div id="app" class="app">
      <form id="quoteForm">
        <div class="form-group">
          <label for="projectType">Tipo de Proyecto:</label>
          <select id="projectType">
            <option value="new-construction">Nueva Construcci√≥n</option>
            <option value="remodel-electrical">Remodelaci√≥n El√©ctrica</option>
            <option value="panel-upgrade-100a">Upgrade Panel 100A</option>
            <option value="panel-upgrade-200a">Upgrade Panel 200A</option>
            <option value="panel-upgrade-400a">Upgrade Panel 400A</option>
            <option value="emergency-service">Servicio de Emergencia</option>
            <option value="rewire-full-house">Rewire Completo de Casa</option>
            <option value="outdoor-wiring">Instalaci√≥n Exterior</option>
            <option value="pool-spa-electrical">Piscina/Spa</option>
            <option value="generator-install">Generador</option>
            <option value="solar-electrical">Conexi√≥n Solar</option>
            <option value="smart-home-full">Smart Home Completo</option>
          </select>
        </div>

        <div class="form-group">
          <label for="city">Ciudad:</label>
          <select id="city">
            <option value="San Francisco">San Francisco</option>
            <option value="Oakland">Oakland</option>
            <option value="San Jose">San Jose</option>
            <option value="Fremont">Fremont</option>
            <option value="Hayward">Hayward</option>
            <option value="Berkeley">Berkeley</option>
            <option value="Richmond">Richmond</option>
            <option value="Sunnyvale">Sunnyvale</option>
            <option value="Palo Alto">Palo Alto</option>
            <option value="Concord">Concord</option>
          </select>
        </div>

        <div class="form-group">
          <label for="days">D√≠as estimados:</label>
          <input type="number" id="days" value="1" min="1" />
          <small>Cada d√≠a = 8 horas</small>
        </div>

        <div class="form-group">
          <label>Ayudantes:</label>
          <div class="controls">
            <button type="button" onclick="removeHelper()">‚àí</button>
            <span id="helperCount">1</span>
            <button type="button" onclick="addHelper()">+</button>
          </div>
        </div>

        <div class="form-group">
          <label>Subir Planos (PDF, JPG):</label>
          <input type="file" id="blueprint" class="form-control-file" accept=".pdf,.jpg,.jpeg,.png">
        </div>

        <div class="form-group">
          <label>Agregar Materiales Manualmente:</label>
          <table id="materialTable">
            <tr>
              <th>Material</th>
              <th>Cantidad</th>
              <th>Precio Unitario</th>
              <th>Total</th>
              <th>Acci√≥n</th>
            </tr>
          </table>
          <button type="button" class="btn" onclick="addMaterialRow()">+ Agregar Material</button>
        </div>

        <div class="form-group markup-control">
          <label>Markup Materiales: <output id="markupValue">30</output>%</label>
          <input type="range" id="materialMarkup" min="25" max="50" value="30" 
                 oninput="document.getElementById('markupValue').textContent = this.value">
          </input>
        </div>

        <button type="button" class="btn" onclick="calculateQuote()">Calcular Cotizaci√≥n</button>
        <button type="button" class="btn" onclick="generatePDF()">üíæ Exportar a PDF</button>
      </form>

      <div id="results"></div>
    </div>
  </div>

  <!-- Librer√≠a para exportar a PDF -->
  <script src="/_estimator/utils/html2pdf.bundle.min.js"></script>

  <!-- Script principal -->
  <script>
    let helperCount = 1;
    let prices = {}, laborRates = {}, permits = {}, materialsDB = {};

    // Verificar contrase√±a
    function checkPassword() {
      const pwd = document.getElementById('password').value;
      if (pwd === 'GoldenCharge2025!') { // üîê Cambia esto por tu contrase√±a
        localStorage.setItem('estimatorAccess', 'true');
        document.getElementById('login').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        loadAllData();
      } else {
        alert('Contrase√±a incorrecta');
      }
    }

    // Verificar acceso al cargar
    window.onload = function () {
      if (localStorage.getItem('estimatorAccess') === 'true') {
        document.getElementById('login').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        loadAllData();
      }
    };

    // Cargar todos los datos
    async function loadAllData() {
      try {
        const res1 = await fetch('/_estimator/data/materials_prices.json');
        prices = await res1.json();

        const res2 = await fetch('/_estimator/data/labor_rates.json');
        laborRates = await res2.json();

        const res3 = await fetch('/_estimator/data/permits.json');
        permits = await res3.json();

        const res4 = await fetch('/_estimator/data/materials_db.json');
        materialsDB = await res4.json();
      } catch (e) {
        console.error("Error cargando datos", e);
        alert("Error: No se pudieron cargar los precios. Verifica las rutas.");
      }
    }

    // Control de ayudantes
    function addHelper() { if (helperCount < 5) helperCount++; document.getElementById('helperCount').textContent = helperCount; }
    function removeHelper() { if (helperCount > 0) helperCount--; document.getElementById('helperCount').textContent = helperCount; }

    // Agregar fila de material
    function addMaterialRow() {
      const table = document.getElementById('materialTable');
      const row = table.insertRow();
      row.innerHTML = `
        <td><input type="text" class="form-control" placeholder="Nombre del material"></td>
        <td><input type="number" class="form-control qty" value="1" min="1"></td>
        <td><input type="number" class="form-control price" value="0" min="0" step="0.01"></td>
        <td class="total">0.00</td>
        <td><button type="button" onclick="this.closest('tr').remove()">Eliminar</button></td>
      `;
      // Actualizar total al cambiar cantidad o precio
      row.querySelectorAll('.qty, .price').forEach(input => {
        input.addEventListener('input', () => {
          const qty = parseFloat(row.querySelector('.qty').value) || 0;
          const price = parseFloat(row.querySelector('.price').value) || 0;
          row.querySelector('.total').textContent = (qty * price).toFixed(2);
        });
      });
    }

    // C√°lculo principal
    async function calculateQuote() {
      const projectKey = document.getElementById('projectType').value;
      const city = document.getElementById('city').value;
      const days = parseFloat(document.getElementById('days').value) || 1;
      const hours = days * 8;
      const markup = parseFloat(document.getElementById('materialMarkup').value) / 100;
      const taxRate = 0.0925;

      const labor = laborRates[city];
      const permitCost = permits[city][projectKey.split('-')[0]] || 0;

      // Materiales del proyecto base (si existe)
      let materialCost = 0;
      const project = materialsDB[projectKey];
      if (project) {
        for (const [item, qty] of Object.entries(project.materials)) {
          materialCost += qty * (prices[item] || 0);
        }
      }

      // Materiales agregados manualmente
      document.querySelectorAll('#materialTable .total').forEach(el => {
        materialCost += parseFloat(el.textContent) || 0;
      });

      const materialSell = materialCost * (1 + markup);
      const taxAmount = materialSell * taxRate;

      // Mano de obra
      const contractorCost = hours * labor.labor_cost.contractor_c10;
      const helperCost = hours * helperCount * labor.labor_cost.helper;
      const totalLaborCost = contractorCost + helperCost;

      const contractorSell = hours * labor.labor_rate.contractor_c10;
      const helperSell = hours * helperCount * labor.labor_rate.helper;
      const totalLaborSell = contractorSell + helperSell;

      // Totales
      const totalCost = materialCost + totalLaborCost + permitCost;
      const totalPrice = materialSell + taxAmount + totalLaborSell + permitCost;
      const profit = totalPrice - totalCost;

      // Precio m√≠nimo y m√°ximo
      const minMarkup = 0.25; // 25%
      const maxMarkup = 0.50; // 50%
      const minPrice = materialCost * (1 + minMarkup) + taxAmount + totalLaborSell + permitCost;
      const maxPrice = materialCost * (1 + maxMarkup) + taxAmount + totalLaborSell + permitCost;

      // Mostrar resultado
      displayResult({
        materialCost, materialSell, taxAmount,
        totalLaborCost, totalLaborSell,
        permitCost, totalCost, totalPrice, profit,
        minPrice, maxPrice, days, hours, helperCount, markup: markup * 100, city, projectKey
      });
    }

    function displayResult(data) {
      const results = document.getElementById('results');
      const blueprintName = document.getElementById('blueprint').files[0]?.name || 'Ninguno';
      results.innerHTML = `
        <div id="quote-result">
          <h2>Cotizaci√≥n: ${data.projectKey.replace(/-/g, ' ').toUpperCase()}</h2>
          <p><strong>Ciudad:</strong> ${data.city}</p>
          <p><strong>D√≠as:</strong> ${data.days} (${data.hours} horas)</p>
          <p><strong>Equipo:</strong> T√∫ + ${data.helperCount} ayudante${data.helperCount !== 1 ? 's' : ''}</p>
          <p><strong>Planos:</strong> ${blueprintName}</p>
          <p><strong>Markup Materiales:</strong> ${data.markup}%</p>
          
          <table>
            <tr><th>Concepto</th><th>Costo Real</th><th>Precio Venta</th></tr>
            <tr><td>Materiales</td><td>$${data.materialCost.toFixed(2)}</td><td>$${data.materialSell.toFixed(2)}</td></tr>
            <tr><td>Impuesto (9.25%)</td><td>-</td><td>$${data.taxAmount.toFixed(2)}</td></tr>
            <tr><td>Mano de Obra</td><td>$${data.totalLaborCost.toFixed(2)}</td><td>$${data.totalLaborSell.toFixed(2)}</td></tr>
            <tr><td>Permisos</td><td>$${data.permitCost.toFixed(2)}</td><td>$${data.permitCost.toFixed(2)}</td></tr>
            <tr class="total-row"><td><strong>Total</strong></td><td><strong>$${data.totalCost.toFixed(2)}</strong></td><td><strong>$${data.totalPrice.toFixed(2)}</strong></td></tr>
          </table>

          <div class="summary">
            <p><strong>Ganancia Neta:</strong> $${data.profit.toFixed(2)} (${((data.profit / data.totalCost) * 100).toFixed(1)}%)</p>
            <p><strong>Precio M√≠nimo Recomendado:</strong> $${data.minPrice.toFixed(2)}</p>
            <p><strong>Precio M√°ximo Recomendado:</strong> $${data.maxPrice.toFixed(2)}</p>
          </div>
        </div>
      `;
    }

    // Exportar a PDF
    function generatePDF() {
      const element = document.getElementById('quote-result');
      const opt = {
        margin: 1,
        filename: 'goldencharge-cotizacion.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().from(element).set(opt).save();
    }
  </script>
</body>
</html>
